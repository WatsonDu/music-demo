<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    
</head>
<link rel="stylesheet" href="song.css">
<link rel="stylesheet" href="reset.css">

<body>
    <div class="page">
        <div class="mysong">
            <div class="mysong-bg"></div>
            <div class="mysong-wrap">
                <div class="mysong-disc">
                    <div class="mysong-turn">
                        <div class="mysong-img spin-run">
                            <img class="img" src="https://i.loli.net/2017/09/04/59ac4a917e603.jpg" alt="">
                        </div>
                    </div>
                  <div class="playbutton"></div>
                </div>
            </div>
            <div class="mysong-info">
                <h2>
                    <span id="songName" class="songname"></span>
                    <span class="space">-</span>
                    <span id="songSinger" class="songsinger"></span>
                </h2>
               <div class="lrc">
                   <div class="mysong-scroll">
                       <div class="mysong-liner"></div>
                   </div>

               </div>
            </div>
            <div class="mysong-foot">
                <div class="foot-wrap">
                    <a href="" class="open">打开</a>
                    <a href="" class="down">下载</a>
                </div>
            </div>
        </div>
        
    </div>
</body>
<script src="./vendors/jquery.min.js"></script>
<script src="./vendors/av-min.js"></script>
<script>
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
</script>
<script>

    var APP_ID = 'oysuL2dORvTNIna81kWEojQM-gzGzoHsz';
    var APP_KEY = 'RuAWNvvWTsPo21IHHUViSmgV';

    AV.init({
        appId: APP_ID,
        appKey: APP_KEY
    });
    var id = getParameterByName('id');
    var query = new AV.Query('Song');
    query.get(id).then(function (song) {
        var {url, lyric} = song.attributes
        var singer = song.attributes.singer
        var name = song.attributes.name
        var images = song.attributes.cover
        var video = document.createElement('video')
        video.src = url
        video.pause()
        video.onplay = function(){

            $('.mysong-disc').addClass('playing')
            $('.playbutton').addClass('active')
        }
        $('.mysong-disc').on('click',function(){
            $('.mysong-disc').removeClass('playing')
            $('.playbutton').removeClass('active')
            video.play()
        })
        $('.playbutton').on('click',function(){
            video.pause()
            $('.mysong-disc').removeClass('playing')
            $('.playbutton').removeClass('active')

        })
        let array =[]
        let parts = lyric.split('\n')
        parts.forEach(function(string,index){
            let xxx = string.split(']')
            xxx[0] = xxx[0].substring(1)
            let lyrictimes = xxx[0].split(':')
            let time = (+lyrictimes[0] *60) + (+lyrictimes[1])
            array.push({
                time:time,
                lyric:xxx[1]
            })
        })



        setInterval(function(){
         let current = video.currentTime
            var $whileliners
            var $lyric = $('.mysong-info>.lrc>.mysong-scroll>.mysong-liner')
            var $name = $('.mysong-info>.songname')
            array.map(function(song){
                if(!song){return}
                var $p = $('<p/>')
                $p.attr('data-time',song.time).text(song.lyric)
                $p.appendTo($('.mysong-scroll').children('.mysong-liner'))
                $
            })
            for(var i = 0;i<array.length;i++){
               if(i ===array,length -1){
                   return
               }else if(array[i].time <= current && array[i+1].time > current){
                 break;
             }
            }
            if($whileliners){
                let top = $whileliners.offset().top
                let linersTop = $('.mysong-liner').offset().top
                let delta = top - linersTop - $('.mysong-scroll').height()/4
                $('.mysong-liner').css('transform',`translateY(-${delta}px)`)
            }
        },300)
    })
</script>
</html>
